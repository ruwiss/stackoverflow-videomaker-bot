<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video İçerik Oluşturucu - YouTube Otomasyon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .step-card {
        border-left: 4px solid #0969da;
        margin-bottom: 1rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        background: white;
      }
      .code-image {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .loading-spinner {
        display: none;
      }
      .result-section {
        display: none;
      }
      .step-text {
        background: #f6f8fa;
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
        border: 1px solid #d0d7de;
      }
      .youtube-field {
        background-color: #ffffff;
        border: 1px solid #d0d7de;
        border-radius: 8px;
        padding: 12px 16px;
        min-height: 44px;
        font-size: 14px;
        line-height: 1.4;
        transition: border-color 0.2s ease;
      }
      .youtube-field:hover {
        border-color: #0969da;
      }
      .thumbnail-placeholder {
        aspect-ratio: 16/9;
        background: linear-gradient(135deg, #f6f8fa 0%, #eaeef2 100%);
        border: 2px dashed #d0d7de;
        border-radius: 12px;
        transition: all 0.3s ease;
      }
      .thumbnail-placeholder:hover {
        border-color: #0969da;
        background: linear-gradient(135deg, #f0f6ff 0%, #dbeafe 100%);
      }
      .youtube-header {
        background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
        border: none;
        box-shadow: 0 2px 8px rgba(255, 0, 0, 0.2);
      }
      .form-label {
        font-weight: 600;
        color: #24292f;
        margin-bottom: 8px;
        font-size: 14px;
      }
      .form-text {
        color: #656d76;
        font-size: 12px;
        margin-top: 6px;
      }
      .tag-badge {
        background: linear-gradient(135deg, #0969da 0%, #0550ae 100%);
        border: none;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 16px;
        margin: 2px;
        box-shadow: 0 1px 3px rgba(9, 105, 218, 0.2);
      }
      .main-card {
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        border: none;
      }
      .sidebar-card {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #d0d7de;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/"> <i class="fab fa-youtube me-2"></i>İçerik Oluşturucu </a>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <div class="col-md-4">
          <div class="card sidebar-card">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Soru Bilgileri</h5>
            </div>
            <div class="card-body">
              <h6 class="text-muted">Başlık:</h6>
              <p class="fw-medium"><%= question.title %></p>

              <h6 class="text-muted">Kategori:</h6>
              <span class="badge bg-primary"><%= question.category %></span>
            </div>
          </div>

          <div class="card sidebar-card mt-3">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Hazırlayıcı</h5>
            </div>
            <div class="card-body">
              <form id="generateForm">
                <button type="submit" class="btn btn-success w-100 fw-medium"><i class="fas fa-magic me-2"></i>Video İçeriği Oluştur</button>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="loading-spinner">
            <div class="card main-card">
              <div class="card-body text-center py-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem">
                  <span class="visually-hidden">Yükleniyor...</span>
                </div>
                <p class="mt-3 fw-medium" id="loadingText">Video içeriği oluşturuluyor...</p>
                <div class="progress" style="height: 12px">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar"></div>
                </div>
                <div class="mt-3">
                  <div id="progressSteps" class="text-start">
                    <!-- Adımlar burada gösterilecek -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="result-section">
            <div class="card main-card">
              <div class="card-header youtube-header text-white">
                <h5 class="mb-0"><i class="fab fa-youtube me-2"></i>YouTube Video Details</h5>
              </div>
              <div class="card-body p-4">
                <!-- Thumbnail and Basic Info -->
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="position-relative">
                      <div class="thumbnail-placeholder d-flex align-items-center justify-content-center" id="thumbnailContainer">
                        <div class="text-center text-muted" id="thumbnailPlaceholder">
                          <i class="fas fa-image fa-3x mb-2"></i>
                          <p class="mb-0 fw-medium">Thumbnail</p>
                          <small>(Coming Soon)</small>
                        </div>
                        <img id="thumbnailImage" class="w-100 h-100" style="display: none; object-fit: cover; border-radius: 12px" alt="Video Thumbnail" />
                      </div>
                      <!-- Yeniden oluştur butonu -->
                      <button id="regenerateThumbnail" class="btn btn-sm btn-outline-primary position-absolute" style="top: 10px; right: 10px; display: none; z-index: 10" title="Yeni tasarım oluştur">
                        <i class="fas fa-sync-alt"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-8">
                    <!-- Video Title -->
                    <div class="mb-3">
                      <label class="form-label">Title</label>
                      <div class="youtube-field" id="videoTitle"></div>
                      <div class="form-text">Add a title that describes your video</div>
                    </div>

                    <!-- Video Description -->
                    <div class="mb-3">
                      <label class="form-label">Description</label>
                      <div class="youtube-field" id="description" style="min-height: 80px"></div>
                      <div class="form-text">Tell viewers about your video</div>
                    </div>
                  </div>
                </div>

                <!-- Tags Section -->
                <div class="mb-4">
                  <label class="form-label">Tags</label>
                  <div id="keywords" class="youtube-field"></div>
                  <div class="form-text">Tags can be useful for finding your content</div>
                </div>

                <!-- Video Steps Section -->
                <div class="mb-4">
                  <label class="form-label"><i class="fas fa-list-ol me-2"></i>Video Script Steps</label>
                  <div id="videoSteps"></div>
                </div>

                <!-- Video Duration Section -->
                <div class="mb-4" id="durationSection" style="display: none">
                  <label class="form-label"><i class="fas fa-clock me-2"></i>Estimated Duration</label>
                  <div class="youtube-field">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-play-circle text-primary me-2"></i>
                      <span id="totalDuration" class="fw-bold fs-5"></span>
                      <small class="text-muted ms-2">minutes</small>
                    </div>
                  </div>
                  <div class="form-text">Estimated time based on reading speed and code complexity</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.getElementById("generateForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const questionId = "<%= question.id %>";
        document.querySelector(".loading-spinner").style.display = "block";
        document.querySelector(".result-section").style.display = "none";

        const progressBar = document.getElementById("progressBar");
        const loadingText = document.getElementById("loadingText");
        const progressSteps = document.getElementById("progressSteps");

        // Progress adımları
        const steps = ["AI ile içerik oluşturuluyor...", "Kod blokları analiz ediliyor...", "Süre hesaplamaları yapılıyor...", "Video içeriği hazırlanıyor...", "Kod resimleri oluşturuluyor...", "Thumbnail oluşturuluyor..."];

        // Progress güncelleyici fonksiyon
        function updateProgress(stepIndex, progress, customMessage = null) {
          progressBar.style.width = progress + "%";
          loadingText.textContent = customMessage || steps[stepIndex] || "İşlem tamamlanıyor...";

          // Adımları göster
          let stepsHtml = "";
          for (let i = 0; i < steps.length; i++) {
            let icon = "";
            let className = "";

            if (i < stepIndex) {
              icon = '<i class="fas fa-check-circle text-success me-2"></i>';
              className = "text-success";
            } else if (i === stepIndex) {
              icon = '<i class="fas fa-spinner fa-spin text-primary me-2"></i>';
              className = "text-primary fw-bold";
            } else {
              icon = '<i class="fas fa-circle text-muted me-2"></i>';
              className = "text-muted";
            }

            stepsHtml += `<div class="mb-1 ${className}">${icon}${steps[i]}</div>`;
          }
          progressSteps.innerHTML = stepsHtml;
        }

        // İlk adımı başlat
        updateProgress(0, 10);

        try {
          // Server-Sent Events ile progress takibi
          const eventSource = new EventSource(`/generate-video-content-stream/${questionId}`);

          eventSource.onmessage = function (event) {
            const data = JSON.parse(event.data);

            if (data.error) {
              eventSource.close();
              document.querySelector(".loading-spinner").style.display = "none";
              alert("Hata: " + data.message);
              return;
            }

            // Progress güncelle
            updateProgress(data.step, data.progress, data.message);

            // Eğer tamamlandıysa sonuçları göster
            if (data.data && data.data.success) {
              eventSource.close();

              setTimeout(() => {
                document.querySelector(".loading-spinner").style.display = "none";

                const result = data.data;

                document.getElementById("videoTitle").textContent = result.data.title;
                document.getElementById("description").textContent = result.data.description;

                const keywordsDiv = document.getElementById("keywords");
                keywordsDiv.innerHTML = result.data.keywords.map((keyword) => `<span class="tag-badge text-white">${keyword}</span>`).join("");

                // Thumbnail göster
                if (result.data.thumbnail) {
                  document.getElementById("thumbnailPlaceholder").style.display = "none";
                  const thumbnailImg = document.getElementById("thumbnailImage");
                  thumbnailImg.src = result.data.thumbnail;
                  thumbnailImg.style.display = "block";

                  // Yeniden oluştur butonunu göster
                  document.getElementById("regenerateThumbnail").style.display = "block";
                }

                // Süre bilgisini göster
                if (result.data.estimatedDurationFormatted) {
                  document.getElementById("totalDuration").textContent = result.data.estimatedDurationFormatted;
                  document.getElementById("durationSection").style.display = "block";
                }

                const stepsDiv = document.getElementById("videoSteps");
                stepsDiv.innerHTML = result.data.steps
                  .map((step, index) => {
                    let stepHtml = `
                      <div class="step-card card mb-3">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-primary fw-bold mb-0"><i class="fas fa-play-circle me-2"></i>Step ${index + 1}</h6>
                            <span class="badge bg-info"><i class="fas fa-clock me-1"></i>${step.duration || 0}s</span>
                          </div>
                          <div class="step-text">${step.text}</div>
                    `;

                    if (step.codeImage) {
                      stepHtml += `
                          <div class="mt-3">
                            <img src="${step.codeImage}" class="code-image" alt="Code Example" onerror="this.style.display='none'">
                          </div>
                      `;
                    }

                    stepHtml += `
                        </div>
                      </div>
                    `;

                    return stepHtml;
                  })
                  .join("");

                document.querySelector(".result-section").style.display = "block";
              }, 1000);
            }
          };

          eventSource.onerror = function (event) {
            eventSource.close();
            document.querySelector(".loading-spinner").style.display = "none";
            alert("Bağlantı hatası oluştu");
          };
        } catch (error) {
          document.querySelector(".loading-spinner").style.display = "none";
          alert("Bir hata oluştu: " + error.message);
        }
      });

      // Thumbnail yeniden oluşturma
      document.getElementById("regenerateThumbnail").addEventListener("click", async function () {
        const questionId = "<%= question.id %>";
        const title = `<%= question.title.replace(/"/g, '\\"') %>`;
        const category = "<%= question.category %>";

        // Butonu deaktif et ve loading göster
        const btn = this;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
          const response = await fetch("/regenerate-thumbnail", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              questionId: questionId,
              title: title,
              category: category,
            }),
          });

          const result = await response.json();

          if (result.success) {
            // Yeni thumbnail'i göster
            const thumbnailImg = document.getElementById("thumbnailImage");
            thumbnailImg.src = result.thumbnail + "?t=" + Date.now(); // Cache busting
          } else {
            alert("Thumbnail oluşturulamadı: " + result.error);
          }
        } catch (error) {
          alert("Hata oluştu: " + error.message);
        } finally {
          // Butonu tekrar aktif et
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
      });
    </script>
  </body>
</html>
